# Game server
В рамках задачи реализованы все требования и написан простой фреймворк.
Что пришлось пропустить в связи с ограниченным временем:

1. ORM
2. Инверсию зависимостей (DI)
3. Отдельное хранение настроек
4. Классный клиент для демонстрации запросов
5. Принцип единой ответственности в некоторых классах не применён )
6. Тесты
7. Удобный деплой

### Требования: ###

1. php > 5.5
2. memcached
3. mysql
4. curl

### Установка: ###

1. git clone git@github.com:bstrx/test-server.git
2. Настроить вебсервер, чтобы хост test-server.dev указывал на папку /web проекта. Имя хоста может быть другим, но тогда обновить файл test.php при тестировании.
3. В mysql создать базу myserver, пользователя user с паролем password. Или изменить эти параметры в Application.
4. Накатить sql из schema.sql

### Проверка/демо: ###

Запустить http://test-server.dev/test.php - он сделает curl запрос как это сделал бы клиент и выведет запрос/ответы. В демо два запроса:

1. Запрос на получения уровня/денег и двух key/value свойств пользователя. Авторизация через реквизиты соцсети.
2. Запрос на обновление уровня и трёх key/value свойств пользователя. Авторизация через id сессии, назначенном на предыдущем шаге.

### Формат запроса/ответа: ###

У каждого запроса есть два ключа:

1. **auth** - для авторизациии на клиенте. Может содержать как реквизиты из соц сети, так и просто id сессии, которая ранее была получена от сервера.
2. **data** - содержит любые данные для контроллеров. В случае запроса информации пользователя, соотвествующий контроллер ждёт перечень данных(уровень, деньги) в массиве с ключом 'info' и key/value свойств пользователя в массиве с ключом 'properties'.
Пример запроса:
```php
Array
(
    [auth] => Array
        (
            [personId] => 03d59e663c1af9ac33a9949d1193505a
            [networkKey] => vk
            [authKey] => 3097e26b7f3cbdb920765a6c3d2ba94985e465c
        )

    [data] => Array
        (
            [info] => Array
                (
                    [0] => level
                    [1] => money
                )

            [properties] => Array
                (
                    [0] => someProperty
                    [1] => anotherProperty
                )

        )

)
```
Ответ от сервера содержит 3 ключа:

1. **status** - int параметр успеха/неуспеха запроса. Аналог http статусов
2. **auth** - тут передаётся только текущая сессия пользователя, чтобы клиент отправил её в следующий раз и сервер бы не обращался к соцсетям
3. **data** - любые данные от контроллеров. К примеру, запрошенная информация по пользователю.
Пример ответа:
```php
Array
(
    [status] => 1
    [auth] => Array
        (
            [sessionId] => 9tuau641r8nigrlkkt3cuudj35
        )

    [data] => Array
        (
            [info] => Array
                (
                    [level] => 55
                    [money] => 53
                )

            [properties] => Array
                (
                    [anotherProperty] => 3217854
                    [someProperty] => Not very long text!!
                )
        )
)
```

### Общеее описание сервера: ###

Все запросы(кроме как к test.php) перенаправляются на index.php, который подключает автолоадер и запускает инстанс Application. Это класс-фасад, который запускает базовые части приложения. Шаги:

1. Инициализирует глобальные сервисы, типа базы данных, кешера, обёртки для сессии. 
2. Создаёт Request - обёртку для запроса пользователя
3. Вызывает аутентификатор пользователя. Если нет активной сессии, тот использует реквизиты для соцсетей. 
4. Вызывает роутер, чтобы понять, какой контроллер/метод вызвать в зависимости от запроса пользователя. Для запроса /user/get-info контроллер будет UserController, а метод getInfoMethod().
5. Вызывает контроллер/метод из предыдущего шага и передаёт ему Request
6. Обрабоданные контроллером данные превращает в Response и отдаёт клиенту.
